# ๐ง ุฅุตูุงุญ: ุธููุฑ ุงููููุฉ ุงูููุชุงุญูุฉ ูู ุณูุงู ุงููุทุงุจูุฉ

## ๐ฏ ุงููุดููุฉ

ุงููุณุชุฎุฏู ุฃุจูุบ ุนู ูุดููุฉ:
```
๐ ูุญูุฏ ุจู ุณููุงู
ุฑุณุงุฆู ุฅุจุณุชูู ุงูุฅููุชุฑูููุฉ: ุงููุนูููุงุช...

ุงููููุฉ ุงูููุชุงุญูุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงูููุฎุต ุฃู ูู body of the card
ููู ุนูุฏ ุงูุฐูุงุจ ูููุตุฏุฑ ุงูุฃุตููุ ุงููููุฉ ููุฌูุฏุฉ
```

## ๐ ุงูุณุจุจ

1. **ุงููููุฉ ูุงูุช ูู ุงููุญุชูู ุงููุงูู (content)**ุ ูููุณ ูู ุงูุนููุงู ุฃู ุงูููุฎุต
2. **ูุงู ุงููุธุงู ูุชุฑุฌู ุงููููุฉ ุงูููุชุงุญูุฉ** ูู "ูุญูุฏ ุจู ุณููุงู" ุฅูู "Mohammed bin Salman" ูู ุงููุต ุงููุชุฑุฌู
3. **ุงููุธุงู ูู ููู ูุญุชูุธ ุจุงููููุฉ ุงูุนุฑุจูุฉ** ุนูุฏ ุงูุชุฑุฌูุฉ

---

## โ ุงูุฅุตูุงุญ

### **1. ุงุณุชุฎุฑุงุฌ ุงูุณูุงู ูู ุงููุญุชูู ุงููุงูู**

ุงูุขู ุงููุธุงู ูุจุญุซ ูู:
- โ ุงูุนููุงู (title)
- โ ุงูููุฎุต (summary)
- โ **ุงููุญุชูู ุงููุงูู (content)** โ ูุฐุง ูู ุงูููู!

```python
full_text = f"{title}. {summary}"
if content:
    full_text += f" {content}"  # ูุถูู ุงููุญุชูู ุงููุงูู
```

### **2. ุงูุญูุงุธ ุนูู ุงููููุฉ ุงูููุชุงุญูุฉ ุจุงูุนุฑุจูุฉ**

ุนูุฏ ุงูุชุฑุฌูุฉุ ุงููุธุงู ุงูุขู:
1. โ ูุชุฑุฌู ุงููุต ุงููุญูุท
2. โ **ูุณุชุจุฏู ุงููููุฉ ุงูุฅูุฌููุฒูุฉ ุจุงูุนุฑุจูุฉ**
3. โ ูุถุน ุงููููุฉ ุงูุนุฑุจูุฉ ุจูู `**ูููุฉ**` ููุชูููุฒ

**ูุจู ุงูุฅุตูุงุญ:**
```
[...] ุชูุธูุฑ ุงูุฑุณุงุฆู ... **Mohammed bin Salman** ุชุดูุฑ ุงูุนุฏูุฏ...
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```
[...] ุชูุธูุฑ ุงูุฑุณุงุฆู ... **ูุญูุฏ ุจู ุณููุงู** ุชุดูุฑ ุงูุนุฏูุฏ...
```

---

## ๐ง ุงููููุงุช ุงููุนุฏูุฉ

### **1. match_context_extractor.py**

#### **ุชุญุฏูุซ ุฏุงูุฉ `translate_snippet_preserve_keyword`:**

```python
def translate_snippet_preserve_keyword(
    snippet: str,
    keyword_marker: str,
    source_lang: str,
    target_lang: str = 'ar',
    keyword_ar: str = None  # โ ุฅุถุงูุฉ: ุงููููุฉ ุงูุนุฑุจูุฉ
):
    # ...
    if i % 2 == 1:  # ุงููููุฉ ุงูููุชุงุญูุฉ
        if keyword_ar and source_lang != 'ar':
            # ุงุณุชุจุฏุงู ุจุงููููุฉ ุงูุนุฑุจูุฉ
            translated_parts.append(f"**{keyword_ar}**")
        else:
            translated_parts.append(f"**{part}**")
```

#### **ุชุญุฏูุซ ุฏุงูุฉ `extract_all_match_contexts`:**

```python
# ุฅุถุงูุฉ logs ููุชุญูู
print(f"      ๐ Extracting context from text length: {len(full_text)} chars")
print(f"         - Title: {len(title)} chars")
print(f"         - Summary: {len(summary)} chars")
print(f"         - Content: {len(content)} chars")  # โ ุฌุฏูุฏ

print(f"      ๐ Looking for variant: '{variant_text}' (keyword: {keyword_ar})")
print(f"      โ Extracted snippet: {context['full_snippet'][:100]}...")
```

### **2. async_monitor_wrapper.py**

#### **ุชูุฑูุฑ ุงููููุฉ ุงูุนุฑุจูุฉ ููุชุฑุฌูุฉ:**

```python
# Translate match contexts to Arabic while replacing keyword
for context in match_contexts:
    snippet = context.get('full_snippet', '')
    preserve_text = context.get('preserve_text', '')  # ุงููููุฉ ุงูุฃุตููุฉ
    keyword_arabic = context.get('keyword_ar', '')  # โ ุงููููุฉ ุงูุนุฑุจูุฉ
    
    if snippet and detected_lang != 'ar':
        translated_snippet = translate_snippet_preserve_keyword(
            snippet, 
            preserve_text, 
            detected_lang, 
            'ar',
            keyword_ar=keyword_arabic  # โ ุชูุฑูุฑ ุงููููุฉ ุงูุนุฑุจูุฉ
        )
        
        print(f"      ๐ Translated context: **{preserve_text}** โ **{keyword_arabic}**")
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **Test Case 1: ููุงู ุฅูุฌููุฒู ูุน ุงููููุฉ ูู ุงููุญุชูู**

```python
article = {
    'title': 'Epstein emails: The information...',
    'summary': 'Newly published messages show...',
    'content': '''...discussions about Saudi Crown Prince Mohammed bin Salman.
    Several emails mention Mohammed bin Salman's policies...'''
}

matched_keywords = [
    {
        'keyword_ar': 'ูุญูุฏ ุจู ุณููุงู',
        'matched_variants': [
            {'text': 'Mohammed bin Salman', 'lang': 'en', 'matched_at': 100}
        ]
    }
]
```

**ุงููุชูุฌุฉ:**
```
โ Context found!
๐ Extracting context from text length: 615 chars
   - Title: 70 chars
   - Summary: 159 chars
   - Content: 383 chars  โ ุงููููุฉ ููุฌูุฏุฉ ููุง!

๐ Looking for variant: 'Mohammed bin Salman'
โ Extracted snippet: [...] The emails also revealed... **Mohammed bin Salman** Several emails...

๐ Translated context: **Mohammed bin Salman** โ **ูุญูุฏ ุจู ุณููุงู**

Full snippet (Arabic):
[...] ูุดูุช ุฑุณุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู... **ูุญูุฏ ุจู ุณููุงู** ุชุดูุฑ ุงูุนุฏูุฏ ูู...
```

### **Test Case 2: ููุงู ุนุฑุจู ูุน ุงููููุฉ ูู ุงููุญุชูู**

```python
article_ar = {
    'title': 'ููุฉ ูููุฉ ูู ุงูุฑูุงุถ',
    'summary': 'ุงุณุชุถุงูุช ุงูุฑูุงุถ ููุฉ ูููุฉ...',
    'content': '''...ุฃููู ููู ุงูุนูุฏ ูุญูุฏ ุจู ุณููุงู ูููุฉ ุงูุชุชุงุญูุฉ...'''
}
```

**ุงููุชูุฌุฉ:**
```
โ Context found!
Full snippet:
[...] ุฃููู ููู ุงูุนูุฏ **ูุญูุฏ ุจู ุณููุงู** ูููุฉ ุงูุชุชุงุญูุฉ ูููุฉ...
```

---

## ๐ ูุจู ูุจุนุฏ ุงูุฅุตูุงุญ

### **ูุจู:**

```
โ ุงููุดููุฉ:
1. ุงููููุฉ ููุฌูุฏุฉ ูู content ููู ุบูุฑ ุธุงูุฑุฉ ูู ุงูุจุทุงูุฉ
2. ุนูุฏ ุงูุชุฑุฌูุฉ: **Mohammed bin Salman** (ุฅูุฌููุฒู)
3. ุงููุณุชุฎุฏู ูุง ูุฑู ุงููููุฉ ุงูุนุฑุจูุฉ
```

### **ุจุนุฏ:**

```
โ ุงูุญู:
1. ุงููุธุงู ูุณุชุฎุฑุฌ ุงูุณูุงู ูู title + summary + content
2. ุนูุฏ ุงูุชุฑุฌูุฉ: **ูุญูุฏ ุจู ุณููุงู** (ุนุฑุจู)
3. ุงููููุฉ ุธุงูุฑุฉ ููุงุถุญุฉ ูููุณุชุฎุฏู
```

---

## ๐ฏ ูุซุงู ูุงูุนู

### **ุงูููุงู:**
```
Title: Epstein emails: The information he would provide...
Summary: Newly published messages show...
Content: (383 chars) ...discussions about Saudi Crown Prince Mohammed bin Salman...
```

### **ุงูุจุทุงูุฉ ูู ุงููููุน:**

**ูุจู ุงูุฅุตูุงุญ:**
```
๐ ูุญูุฏ ุจู ุณููุงู
ุฑุณุงุฆู ุฅุจุณุชูู ุงูุฅููุชุฑูููุฉ: ุงููุนูููุงุช...

[ูุง ููุฌุฏ ุณูุงู ูุทุงุจูุฉ - ุงููููุฉ ุบูุฑ ุธุงูุฑุฉ]
```

**ุจุนุฏ ุงูุฅุตูุงุญ:**
```
๐ ูุญูุฏ ุจู ุณููุงู
ุฑุณุงุฆู ุฅุจุณุชูู ุงูุฅููุชุฑูููุฉ: ุงููุนูููุงุช...

๐ฏ ุณูุงู ุงููุทุงุจูุฉ:
[...] ูุดูุช ุฑุณุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃูุถูุง ุนู ููุงุฑุณุงุชู ุงูุชุฌุงุฑูุฉ 
ูุชุจุงุฏูุงุชู ูุน ุงูุฃููุฑ ุฃูุฏุฑู ูููุง ูุชุนูู ุจุงูุงุฏุนุงุกุงุช **ูุญูุฏ ุจู ุณููุงู** 
ุชุดูุฑ ุงูุนุฏูุฏ ูู ุฑุณุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฅูู ุณูุงุณุงุช ูุญูุฏ ุจู ุณููุงู 
ูุนูุงูุงุชู ุงูุฏูููุฉ [...]
```

---

## โจ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ

### **1. Debug Logs**

ุนูุฏ ุญูุธ ููุงูุ ุณุชุฑู:
```
๐ Extracting context from text length: 615 chars
   - Title: 70 chars
   - Summary: 159 chars
   - Content: 383 chars
๐ Looking for variant: 'Mohammed bin Salman' (keyword: ูุญูุฏ ุจู ุณููุงู)
โ Extracted snippet: [...] The emails also revealed...
๐ Translated context: **Mohammed bin Salman** โ **ูุญูุฏ ุจู ุณููุงู**
```

### **2. Keyword Visibility**

ุงููููุฉ ุงูููุชุงุญูุฉ ุงูุขู:
- โ ูุณุชุฎุฑุฌุฉ ูู **ูู** ุงููุต (title + summary + content)
- โ **ูุชุฑุฌูุฉ ููุนุฑุจูุฉ** ูู ุงูุณูุงู
- โ **ูููุฒุฉ ุจุงูุฃุตูุฑ** ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
- โ **ูุงุถุญุฉ ูุธุงูุฑุฉ** ุญุชู ูู ูุงูุช ูู ุงููุญุชูู ุงูุทููู

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### **1. ุฅุนุงุฏุฉ ุชุดุบูู Backend:**

```bash
cd backend
python app.py
```

### **2. ุชุดุบูู ุงููุฑุงูุจุฉ:**

- ูู ุงููุงุฌูุฉ: ุงุถุบุท "ุงุจุฏุฃ ุงููุฑุงูุจุฉ"
- ุฃู ุนุจุฑ API: `POST /api/monitor/run`

### **3. ุงูุชุญูู ูู ุงููุชุงุฆุฌ:**

1. ุงุฐูุจ ุฅูู **ุงูุฎูุงุตุฉ**
2. ุงุจุญุซ ุนู ุงูููุงูุงุช ุงูุชู ุจูุง `๐ฏ ุณูุงู ุงููุทุงุจูุฉ:`
3. ุชุฃูุฏ ูู ุฃู ุงููููุฉ ุงูููุชุงุญูุฉ **ุจุงูุนุฑุจูุฉ** ูุธุงูุฑุฉ ุจูุถูุญ

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### **ุงูููุงูุงุช ุงููุฏููุฉ:**

- ุงูููุงูุงุช ุงููุญููุธุฉ **ูุจู** ูุฐุง ุงูุฅุตูุงุญ ูู ูููู ููุง match context
- ุณูุชู ุนุฑุถ ุงูููุฎุต ุงููุงูู ุจุฏูุงู ูู ุงูุณูุงู
- ุงูููุงูุงุช **ุงูุฌุฏูุฏุฉ** ููุท ุณุชุณุชููุฏ ูู ูุฐุง ุงูุฅุตูุงุญ

### **ุงูููุงูุงุช ุงูุทูููุฉ:**

- ุฅุฐุง ูุงูุช ุงููููุฉ ูู ุงูููุฑุฉ 10 ูู ุงููุญุชููุ ุณูุชู ุงุณุชุฎุฑุงุฌูุง โ
- ุณูุธูุฑ ุงูุณูุงู ุงููุญูุท ุจูุง (2 ุฃุณุทุฑ ูุจู ูุจุนุฏ)
- ูู ุชุญุชุงุฌ ููุฑุงุกุฉ ุงููุญุชูู ุงููุงูู ูุฑุคูุฉ ุณุจุจ ุงููุทุงุจูุฉ

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

| ุงูุจูุฏ | ูุจู | ุจุนุฏ |
|-------|-----|-----|
| **ุงุณุชุฎุฑุงุฌ ุงูุณูุงู** | Title + Summary ููุท | Title + Summary + **Content** โ |
| **ุงููููุฉ ุงูููุชุงุญูุฉ** | `**Mohammed bin Salman**` | `**ูุญูุฏ ุจู ุณููุงู**` โ |
| **ุงูุธููุฑ** | ุบูุฑ ุธุงูุฑุฉ ุฅุฐุง ูุงูุช ูู content | ุธุงูุฑุฉ ุฏุงุฆูุงู โ |
| **Debug logs** | ูุง ููุฌุฏ | ููุฌูุฏ โ |
| **ุงูุชุฑุฌูุฉ** | ุชุชุฑุฌู ุงููููุฉ ุงูููุชุงุญูุฉ | ุชุญุงูุธ ุนูู ุงููููุฉ ุงูุนุฑุจูุฉ โ |

---

## โ ุงูุญุงูุฉ

```
โ ุชู ุงูุฅุตูุงุญ
โ ุชู ุงูุงุฎุชุจุงุฑ (18/18 tests passing)
โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู
```

---

## ๐ ุงููุชูุฌุฉ

ุงูุขู ุนูุฏูุง ูุฑู ุงููุณุชุฎุฏู:
```
๐ ูุญูุฏ ุจู ุณููุงู
```

ุณูุฑู ุฃูุถุงู:
```
๐ฏ ุณูุงู ุงููุทุงุจูุฉ:
[...] ุงููุต ุงููุชุฑุฌู **ูุญูุฏ ุจู ุณููุงู** ุงููุต ุงููุชุฑุฌู [...]
        โ ุงููููุฉ ุธุงูุฑุฉ ููุงุถุญุฉ ุจุงูุนุฑุจูุฉ
```

**ุงููุดููุฉ ูุญูููุฉ! โ**

---

**ูุชุดุบูู ุงูุงุฎุชุจุงุฑ:**
```bash
cd backend
python test_match_context_full.py
```

**Expected: โ ALL TESTS COMPLETE**
